/*
 Copyright 2013
 jQuery bitty v1.0

 base jquery.history.js
 @see https://github.com/browserstate/history.js 

 base doT.js
 @see https://github.com/olado/doT 

 @author yutlee.cn@gmail.com
 Date 2013-8-23
 Update 2013-9-26
*/
(function(f,h,x){function u(a){return a.replace(/^\s+|\s+$/g,"")}function s(a){return a&&!a.nodeType&&"[object Object]"===Object.prototype.toString.call(a)}function p(a){return"function"===typeof a}function l(a){return"[object Array]"===Object.prototype.toString.call(a)}function t(a){return"[object String]"===Object.prototype.toString.call(a)}function m(a,c){if(!l(a)||!l(c))return!1;if(l(a)&&l(c)){for(var b=[],d=0,e=a.length,f=c.length;d<e;d++)for(var g=0;g<f&&a[d]!==c[g];g++)g===f-1&&a[d]!==c[g]&&
b.push(a[d]);return b}}var k=h.app=h.app||{};k.bitty={tempCache:{},currentUrlCache:[],tempUrlCache:[],pageCache:{},htmlCache:{},jsCache:{},cssCache:{},dominRegExp:RegExp("(https|http)://[^/]*/","g"),headers:{Accept:"application/json","X-Referer":h.location.href},replacePath:function(a){return a.replace(this.dominRegExp,"").replace(/[^(\-|\w)]/g,"-")},init:function(a,c){var b=c.temp_id;if(s(b)){var d=c.temp_url;0<this.currentUrlCache.length&&m(this.currentUrlCache,d);a=a.replace(this.dominRegExp,"");
this.pageCache[a]||(this.pageCache[a]={});this.pageCache[a].temps||(this.pageCache[a].temps=d.join(","));this.pageCache[a].allTemps||(this.pageCache[a].allTemps=d.join(","));this.currentUrlCache=d;for(var e in b)d=b[e],this.replacePath(d),this.tempCache[d]||p(this.tempCache[d])||(this.tempCache[d]=doT.template(c.temp[e]),this.tempUrlCache.push(d))}this.bindLink()},loadPage:function(a,c){var b=this,d=c.temp_id,e=c.hint;if(s(e))return t(e.url)&&b.request({url:e.url,title:e.title}),t(e.error_tip)&&""!=
u(e.error_tip)&&(k.tooltip.destroy(),k.tooltip.error(e.error_tip)),t(e.success_tip)&&""!=u(e.success_tip)&&(k.tooltip.destroy(),k.tooltip.success(e.success_tip,3E3)),t(e.warning_tip)&&""!=u(e.warning_tip)&&(k.tooltip.destroy(),k.tooltip.warning(e.warning_tip)),!1;if(s(d)){for(var q=c.temp_url,e=0<b.currentUrlCache.length?m(b.currentUrlCache,q):q,g=0,h=e.length;g<h;g++){var n=b.replacePath(e[g]);0<f("#"+n).length&&f("#"+n).remove()}a=a.replace(b.dominRegExp,"");b.pageCache[a]||(b.pageCache[a]={});
b.pageCache[a].temps||(b.pageCache[a].temps=q.join(","));b.pageCache[a].allTemps||(b.pageCache[a].allTemps=q.join(","));b.currentUrlCache=q;for(var r in d){var e=parseInt(r.replace(/[^\d]/g,"")),g=d[r],n=b.replacePath(g),v;b.tempCache[g]||p(b.tempCache[g])||(b.tempCache[g]=doT.template(c.temp[r]),b.tempUrlCache.push(g));v=s(c.data)?b.tempCache[g](c.data[r]):b.tempCache[g]("");0<f("#"+n).length&&f("#"+n).remove();var w=function(a){a-=1;if(0>a)f(c.mod[r]).prepend(f('<div id="'+n+'"/>').html(v));else{var d=
b.replacePath(q[a]),d=f(c.mod[r]).find("#"+d);1===d.length?d.after(f('<div id="'+n+'"/>').html(v)):w(a-1)}};w(e)}b.loadCss(c.css_url);b.loadJs(c.js_url);if(l(b.finalJs)){for(d=0;d<b.finalJs;d++)b.finalJs[d]=b.finalJs[d].replace(b.dominRegExp,"");b.loadJs(b.finalJs)}}},getCompleteHtml:function(a){var c=a.temp_id,b="",d;for(d in c){var e=c[d];this.tempCache[e]||p(this.tempCache[e])||(this.tempCache[e]=doT.template(a.temp[d]),this.tempUrlCache.push(e));b+=s(a.data)?this.tempCache[e](a.data[d]):this.tempCache[e]("")}return b},
loadJs:function(a){function c(a,b){f.ajax({url:a,cache:b,dataType:"script"})}var b=0,d;if(l(a))for(d=a.length;b<d;b++){var e=a[b];this.jsCache[e]?c(e,!0):(c(e,!1),this.jsCache[e]=e)}},loadCss:function(a){var c=0,b;if(l(a))for(b=a.length;c<b;c++){var d=a[c];this.cssCache[d]||(f("head").append('<link rel="stylesheet" href="'+d+'" />'),this.cssCache[d]=d)}},refreshPageCache:function(a){var c,b;for(b in this.pageCache)if(b===a&&this.pageCache[b].temps&&this.currentUrlCache){a=m(this.pageCache[b].allTemps.split(","),
this.currentUrlCache);a=m(a,this.pageCache[b].temps.split(","));c=this.pageCache[b].temps.split(",");for(var d=0;d<a.length;d++)c.push(a[d]);this.pageCache[b].reTemps=c.join(",");break}},setHeaders:function(a,c){var b;a=a.replace(this.dominRegExp,"");this.pageCache[a]||(this.pageCache[a]={});this.refreshPageCache(a);c&&""!=c?(this.headers.Temps=this.pageCache[a].temps=this.pageCache[a].reTemps=c,b=m(c.split(","),this.tempUrlCache),this.headers["No-Exist"]=b.join(",")):this.pageCache[a].reTemps?(this.headers.Temps=
this.pageCache[a].reTemps,b=m(this.pageCache[a].reTemps.split(","),this.tempUrlCache),this.headers["No-Exist"]=b.join(",")):(this.headers.Temps="",this.headers["No-Exist"]="none")},loading:{msg:"\u52a0\u8f7d\u4e2d...",beforeSend:function(a,c){for(var b=0;b<a.length;b++)f("#"+a[b]).parent().addClass("loading")},success:function(a,c){for(var b=0;b<a.length;b++)f("#"+a[b]).parent().removeClass("loading")}},ajax:function(a){var c=this,b=f.extend({url:"",dataType:"json",headers:c.headers,type:"GET",data:null,
callback:null},a||{}),d=[];f.ajax({url:b.url,type:b.type,dataType:"json",headers:c.headers,data:b.data,beforeSend:function(){c.latestRequest=b.url;if(p(c.loading.beforeSend)){for(var a=c.headers.Temps?m(c.currentUrlCache,c.headers.Temps.split(",")):c.currentUrlCache,f=0,g=a.length,a=0<g?a:c.currentUrlCache,g=a.length;f<g;f++)d.push(c.replacePath(a[f]));c.loading.beforeSend.call(c.loading,d,b.url)}},success:function(a){if(c.latestRequest===b.url){b.isHistory&&(History.pushState("",b.title,b.url),History.replaceState("",
b.title,b.url));c.isLinkClick=!1;p(c.loading.success)&&c.loading.success.call(c.loading,d,b.url);if(p(b.callback)&&!b.callback.call(c,a))return!1;c.loadPage(b.url,a)}},complete:function(){},error:function(a,b,c){}})},request:function(a){a=f.extend({url:"",temps:"",isHistory:!0,title:document.title,type:"GET",data:null,callback:null},a||{});this.isLinkClick=!0;this.setHeaders(a.url,a.temps);this.ajax({url:a.url,isHistory:a.isHistory,title:a.title,type:a.type,data:a.data,callback:a.callback})},refresh:function(){this.request({url:h.location.href})},
bindLink:function(){var a=this;f("body").delegate("a:not([target=_blank],[target=_top],[target=_parent],[target=_self])","click",function(){var c=f(this),b=c.attr("href"),d=c.attr("data-temps"),c=c.attr("data-title");if(!f.trim(b).match(/#.*/)&&!f.trim(b).match(/javascript:/))return a.request({url:b,temps:d,title:c}),!1})},ajaxForm:function(a){a=f.extend({formId:null,submitId:null,url:null,method:null,isHistory:!0,title:document.title,temps:"",callback:null},a||{});if(!a.formId)if(a.submitId){var c=
f("#"+a.submitId);a.formId=c.closest("form")[0]}else return!1;c=t(a.formId)?f("#"+a.formId):f(a.formId);if(!a.method){var b=c.attr("method");a.method=b?b.toLocaleUpperCase():"GET"}a.url||(b=c.attr("action"),a.url=b?b:h.location.href);c=c.serialize();c=decodeURIComponent(c,!0);"POST"==a.method?(b=c,a.isHistory=!1):(b="",a.url=a.url.match(/&$/g)?a.url+c:a.url+"&"+c);this.isLinkClick=!0;this.setHeaders(a.url,a.temps);this.ajax({url:a.url,type:a.method,data:b,isHistory:a.isHistory,title:a.title,callback:a.callback});
return!1}};History.Adapter.bind(h,"statechange",function(){var a=k.bitty,c=History.getState(!1).url;a.isLinkClick||(a.setHeaders(c),a.ajax({url:c}))})})(jQuery,window);
